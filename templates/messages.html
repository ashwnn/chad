{% extends "base.html" %}

{% block title %}Bot Messages Configuration - Chad Bot Admin{% endblock %}

{% block content %}
<div class="md:flex md:items-center md:justify-between mb-8">
  <div class="min-w-0 flex-1">
    <h2 class="text-2xl font-bold leading-7 text-white sm:truncate sm:text-3xl sm:tracking-tight">Bot Messages &
      Settings</h2>
    <p class="mt-2 text-sm text-vercel-text-secondary">Configure all bot messages, system prompt, and reply formatting.
    </p>
  </div>
</div>

<form id="messages-form" class="space-y-8">
  <!-- Bot Settings -->
  <div class="rounded-xl bg-vercel-card border border-vercel-border overflow-hidden">
    <div class="border-b border-vercel-border px-6 py-4">
      <h3 class="text-base font-semibold text-white">Bot Settings</h3>
      <p class="mt-1 text-sm text-vercel-text-muted">Global reply formatting options.</p>
    </div>
    <div class="px-6 py-6">
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        <div>
          <label for="reply_prefix" class="block text-sm font-medium text-white mb-2">Reply Prefix (optional)</label>
          <input type="text" id="reply_prefix" placeholder="Text to add before every bot reply"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
          <p class="mt-1.5 text-xs text-vercel-text-muted">Leave empty for no prefix</p>
        </div>

        <div>
          <label for="reply_suffix" class="block text-sm font-medium text-white mb-2">Reply Suffix (optional)</label>
          <input type="text" id="reply_suffix" placeholder="Text to add after every bot reply"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
          <p class="mt-1.5 text-xs text-vercel-text-muted">Leave empty for no suffix</p>
        </div>

        <div class="sm:col-span-2">
          <label for="sync_allowed_user_ids" class="block text-sm font-medium text-white mb-2">Sync Authorized User
            IDs</label>
          <input type="text" id="sync_allowed_user_ids"
            placeholder="Comma-separated Discord User IDs (e.g. 123456789, 987654321)"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
          <p class="mt-1.5 text-xs text-vercel-text-muted">User IDs allowed to run the /sync command. Replaces the
            environment variable if set here.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Global System Prompt -->
  <div class="rounded-xl bg-vercel-card border border-vercel-border overflow-hidden">
    <div class="border-b border-vercel-border px-6 py-4">
      <h3 class="text-base font-semibold text-white">Global System Prompt</h3>
      <p class="mt-1 text-sm text-vercel-text-muted">Global default for AI's personality and behavior.</p>
    </div>
    <div class="px-6 py-6">
      <textarea id="system_prompt" rows="6" placeholder="Enter the system prompt..."
        class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-3 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm"></textarea>
      <p class="mt-2 text-sm text-vercel-text-muted">Be specific about tone, content restrictions, and desired behavior.
        This is the fallback when guilds don't have a custom system prompt.</p>
    </div>
  </div>

  <!-- Error & Validation Messages -->
  <div class="rounded-xl bg-vercel-card border border-vercel-border overflow-hidden">
    <div class="border-b border-vercel-border px-6 py-4">
      <h3 class="text-base font-semibold text-white">Error & Validation Messages</h3>
      <p class="mt-1 text-sm text-vercel-text-muted">Messages shown to users when validation fails.</p>
    </div>
    <div class="px-6 py-6">
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        {% for key, label, placeholder, hint in [
        ('msg_empty_input', 'Empty Input', 'Message for empty input', ''),
        ('msg_too_short', 'Too Short', 'Message for too short input', ''),
        ('msg_trivial_input', 'Trivial Input', 'Message for trivial input (hi, hello, test)', ''),
        ('msg_gibberish', 'Gibberish', 'Message for gibberish input', ''),
        ('msg_too_long', 'Too Long', 'Message for too long input', 'Use {max_chars} for character limit'),
        ('msg_duplicate', 'Duplicate', 'Message for duplicate requests', '')
        ] %}
        <div>
          <label for="{{ key }}" class="block text-sm font-medium text-white mb-2">{{ label }}</label>
          <input type="text" id="{{ key }}" placeholder="{{ placeholder }}"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
          {% if hint %}
          <p class="mt-1.5 text-xs text-vercel-text-muted">{{ hint }}</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Rate Limiting Messages -->
  <div class="rounded-xl bg-vercel-card border border-vercel-border overflow-hidden">
    <div class="border-b border-vercel-border px-6 py-4">
      <h3 class="text-base font-semibold text-white">Rate Limiting Messages</h3>
      <p class="mt-1 text-sm text-vercel-text-muted">Messages shown when users hit rate limits.</p>
    </div>
    <div class="px-6 py-6">
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        <div>
          <label for="msg_rate_limit_chat" class="block text-sm font-medium text-white mb-2">Chat Rate Limit</label>
          <input type="text" id="msg_rate_limit_chat" placeholder="Message when chat rate limit hit"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
        </div>
      </div>
    </div>
  </div>

  <!-- Budget Messages -->
  <div class="rounded-xl bg-vercel-card border border-vercel-border overflow-hidden">
    <div class="border-b border-vercel-border px-6 py-4">
      <h3 class="text-base font-semibold text-white">Budget Messages</h3>
      <p class="mt-1 text-sm text-vercel-text-muted">Messages shown when budgets are exhausted.</p>
    </div>
    <div class="px-6 py-6">
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        <div>
          <label for="msg_chat_budget_user" class="block text-sm font-medium text-white mb-2">User Chat Budget
            Exhausted</label>
          <input type="text" id="msg_chat_budget_user" placeholder="Message when user chat budget exhausted"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
        </div>
        <div>
          <label for="msg_chat_budget_guild" class="block text-sm font-medium text-white mb-2">Guild Chat Budget
            Exhausted</label>
          <input type="text" id="msg_chat_budget_guild" placeholder="Message when guild chat budget exhausted"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
        </div>
      </div>
    </div>
  </div>

  <!-- Workflow Messages -->
  <div class="rounded-xl bg-vercel-card border border-vercel-border overflow-hidden">
    <div class="border-b border-vercel-border px-6 py-4">
      <h3 class="text-base font-semibold text-white">Workflow Messages</h3>
      <p class="mt-1 text-sm text-vercel-text-muted">Messages for approval workflow states.</p>
    </div>
    <div class="px-6 py-6">
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        {% for key, label, placeholder in [
        ('msg_pending_approval_chat', 'Pending Approval', 'Message for pending chat approval'),
        ('msg_manual_reply_default', 'Default Manual Reply', 'Default admin manual reply'),
        ('msg_rejection_default', 'Default Rejection', 'Default rejection message')
        ] %}
        <div>
          <label for="{{ key }}" class="block text-sm font-medium text-white mb-2">{{ label }}</label>
          <input type="text" id="{{ key }}" placeholder="{{ placeholder }}"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- System Error Messages -->
  <div class="rounded-xl bg-vercel-card border border-vercel-border overflow-hidden">
    <div class="border-b border-vercel-border px-6 py-4">
      <h3 class="text-base font-semibold text-white">System Error Messages</h3>
      <p class="mt-1 text-sm text-vercel-text-muted">Messages for system-level errors.</p>
    </div>
    <div class="px-6 py-6">
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        {% for key, label, placeholder in [
        ('msg_ai_error_chat', 'AI Chat Service Error', 'Message when AI chat service fails'),
        ('msg_dm_not_allowed', 'DM Not Allowed', 'Message when command used in DM'),
        ('msg_invalid_input', 'Invalid Input', 'Generic invalid input message'),
        ('msg_unknown_error', 'Unknown Error', 'Generic error message')
        ] %}
        <div>
          <label for="{{ key }}" class="block text-sm font-medium text-white mb-2">{{ label }}</label>
          <input type="text" id="{{ key }}" placeholder="{{ placeholder }}"
            class="block w-full rounded-lg bg-vercel-surface border border-vercel-border py-2.5 px-4 text-white placeholder:text-vercel-text-muted focus:border-vercel-blue focus:ring-1 focus:ring-vercel-blue sm:text-sm">
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="flex items-center justify-end gap-x-4 border-t border-vercel-border px-6 py-4 bg-white/[0.02]">
      <button type="button" onclick="loadMessages()"
        class="rounded-lg bg-white/10 border border-vercel-border px-4 py-2.5 text-sm font-semibold text-white hover:bg-white/20 transition-all">Reset</button>
      <button type="submit"
        class="rounded-lg bg-white px-5 py-2.5 text-sm font-semibold text-black hover:bg-white/90 transition-all hover:shadow-glow-sm">
        Save All Changes
      </button>
    </div>
  </div>
</form>

<!-- Notification Toast -->
<div id="notification" class="fixed bottom-4 right-4 z-50 hidden">
  <div class="rounded-lg p-4 shadow-lg border">
    <div class="flex items-center gap-x-3">
      <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd"
          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
          clip-rule="evenodd" />
      </svg>
      <p class="text-sm font-medium" id="notification-text"></p>
    </div>
  </div>
</div>

<script>
  let currentConfig = {};

  async function loadMessages() {
    try {
      const response = await fetch('/api/yaml-config');
      const data = await response.json();
      currentConfig = data;

      document.getElementById('reply_prefix').value = data.bot_settings?.reply_prefix || '';
      document.getElementById('reply_suffix').value = data.bot_settings?.reply_suffix || '';

      const syncIds = data.bot_settings?.sync_allowed_user_ids || [];
      document.getElementById('sync_allowed_user_ids').value = Array.isArray(syncIds) ? syncIds.join(', ') : syncIds;

      document.getElementById('system_prompt').value = data.system_prompt || '';

      const messages = data.messages || {};
      for (const [key, value] of Object.entries(messages)) {
        const input = document.getElementById('msg_' + key);
        if (input) {
          input.value = value;
        }
      }

      showStatus('Configuration loaded', 'success');
    } catch (error) {
      showStatus('Error loading configuration: ' + error.message, 'error');
    }
  }

  async function saveMessages(e) {
    e.preventDefault();

    const updates = {
      'bot_settings.reply_prefix': document.getElementById('reply_prefix').value,
      'bot_settings.reply_suffix': document.getElementById('reply_suffix').value,
      'bot_settings.sync_allowed_user_ids': document.getElementById('sync_allowed_user_ids').value
        .split(',')
        .map(id => id.trim())
        .filter(id => id.length > 0),
      'system_prompt': document.getElementById('system_prompt').value,
    };

    const messageKeys = [
      'empty_input', 'too_short', 'trivial_input', 'gibberish', 'too_long', 'duplicate',
      'rate_limit_chat', 'chat_budget_user', 'chat_budget_guild',
      'pending_approval_chat', 'manual_reply_default', 'rejection_default',
      'ai_error_chat', 'dm_not_allowed', 'invalid_input', 'unknown_error'
    ];

    for (const key of messageKeys) {
      const input = document.getElementById('msg_' + key);
      if (input) {
        updates['messages.' + key] = input.value;
      }
    }

    try {
      const response = await fetch('/api/yaml-config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates })
      });

      if (!response.ok) {
        throw new Error('Failed to save configuration');
      }

      const result = await response.json();
      showStatus('Configuration saved successfully!', 'success');
      currentConfig = result.config;
    } catch (error) {
      showStatus('Error saving configuration: ' + error.message, 'error');
    }
  }

  function showStatus(message, type) {
    const notification = document.getElementById('notification');
    const text = document.getElementById('notification-text');
    const icon = notification.querySelector('svg');

    text.textContent = message;
    notification.classList.remove('hidden');

    if (type === 'success') {
      notification.querySelector('div').className = 'rounded-lg bg-vercel-green/10 border border-vercel-green/20 p-4 shadow-lg';
      text.className = 'text-sm font-medium text-vercel-green';
      icon.className = 'h-5 w-5 text-vercel-green';
    } else {
      notification.querySelector('div').className = 'rounded-lg bg-vercel-red/10 border border-vercel-red/20 p-4 shadow-lg';
      text.className = 'text-sm font-medium text-vercel-red';
      icon.className = 'h-5 w-5 text-vercel-red';
    }

    setTimeout(() => {
      notification.classList.add('hidden');
    }, 5000);
  }

  document.getElementById('messages-form').addEventListener('submit', saveMessages);
  document.addEventListener('DOMContentLoaded', loadMessages);
</script>
{% endblock %}