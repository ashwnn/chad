{% extends "base.html" %}

{% block title %}Bot Messages Configuration - Chad Bot Admin{% endblock %}

{% block content %}
<div class="md:flex md:items-center md:justify-between mb-8">
  <div class="min-w-0 flex-1">
    <h2
      class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-indigo-600">
      Global Messages
    </h2>
    <p class="mt-2 text-sm font-medium text-gray-500">
      Configure fallback messages, reply formatting, and default AI persona.
    </p>
  </div>
</div>

<form id="messages-form" class="space-y-8">
  <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
    <div class="space-y-2">
      <h3 class="text-lg font-bold text-gray-900">Reply Context</h3>
      <p class="text-sm text-gray-500 leading-relaxed">
        Add custom branding or disclaimers to every interaction.
      </p>
    </div>

    <div class="lg:col-span-2 space-y-6">
      <div class="glass-panel rounded-2xl p-6 sm:p-8 grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <label for="reply_prefix" class="block text-sm font-bold text-gray-900 mb-2">Reply Prefix</label>
          <input type="text" id="reply_prefix" placeholder="e.g. [Chad] "
            class="block w-full rounded-xl border-gray-200 bg-white/50 py-3 px-4 text-gray-900 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
        </div>
        <div>
          <label for="reply_suffix" class="block text-sm font-bold text-gray-900 mb-2">Reply Suffix</label>
          <input type="text" id="reply_suffix" placeholder="e.g. - Sent via Chad"
            class="block w-full rounded-xl border-gray-200 bg-white/50 py-3 px-4 text-gray-900 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
        </div>
      </div>
    </div>
  </div>

  <div class="border-t border-gray-100 pt-8 grid grid-cols-1 gap-8 lg:grid-cols-3">
    <div class="space-y-2">
      <h3 class="text-lg font-bold text-gray-900">Default AI Persona</h3>
      <p class="text-sm text-gray-500 leading-relaxed">
        The base instructions used when a guild doesn't have a custom prompt.
      </p>
    </div>

    <div class="lg:col-span-2">
      <div class="glass-panel rounded-2xl p-6 sm:p-8">
        <textarea id="system_prompt" rows="8" placeholder="Enter default AI instructions..."
          class="block w-full rounded-xl border-gray-200 bg-white/50 py-3 px-4 text-gray-900 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm"></textarea>
      </div>
    </div>
  </div>

  <div class="border-t border-gray-100 pt-8 grid grid-cols-1 gap-8 lg:grid-cols-3">
    <div class="space-y-2">
      <h3 class="text-lg font-bold text-gray-900">System Responses</h3>
      <p class="text-sm text-gray-500 leading-relaxed">
        Customize the literal strings used for various bot states.
      </p>
    </div>

    <div class="lg:col-span-2 space-y-8">
      <!-- Grouped Message Sections -->
      <div class="glass-panel rounded-2xl p-6 sm:p-8 space-y-6">
        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest border-b border-gray-100 pb-2">Validation
          Errors</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          {% for key, label in [
          ('empty_input', 'Empty Input'),
          ('too_short', 'Too Short'),
          ('trivial_input', 'Trivial Input'),
          ('gibberish', 'Gibberish'),
          ('too_long', 'Too Long'),
          ('duplicate', 'Duplicate Request')
          ] %}
          <div>
            <label for="msg_{{ key }}" class="block text-xs font-bold text-gray-700 mb-2 uppercase">{{ label }}</label>
            <input type="text" id="msg_{{ key }}"
              class="block w-full rounded-xl border-gray-200 bg-white/50 py-2 px-3 text-gray-900 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm">
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="glass-panel rounded-2xl p-6 sm:p-8 space-y-6">
        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest border-b border-gray-100 pb-2">Quotas &
          Safety</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          {% for key, label in [
          ('rate_limit_chat', 'Rate Limited'),
          ('chat_budget_user', 'User Budget Full'),
          ('chat_budget_guild', 'Guild Budget Full'),
          ('pending_approval_chat', 'Pending Approval'),
          ('rejection_default', 'Default Rejection'),
          ('ai_error_chat', 'AI Service Error')
          ] %}
          <div>
            <label for="msg_{{ key }}" class="block text-xs font-bold text-gray-700 mb-2 uppercase">{{ label }}</label>
            <input type="text" id="msg_{{ key }}"
              class="block w-full rounded-xl border-gray-200 bg-white/50 py-2 px-3 text-gray-900 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm">
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="flex items-center justify-end gap-x-4 pt-10">
    <button type="button" class="text-sm font-bold text-gray-500 hover:text-gray-700 transition-colors"
      onclick="loadMessages()">
      Reset
    </button>
    <button type="submit"
      class="rounded-xl bg-gradient-to-r from-brand-600 to-indigo-600 px-6 py-3 text-sm font-bold text-white shadow-lg hover:shadow-brand-500/20 transition-all hover:-translate-y-0.5 active:translate-y-0">
      Save All Changes
    </button>
  </div>
</form>

<div id="notification"
  class="fixed bottom-4 right-4 z-50 pointer-events-none transition-all duration-300 transform translate-y-20 opacity-0">
  <div class="bg-white rounded-2xl border p-4 shadow-xl flex items-center gap-3">
    <div id="notification-icon" class="w-8 h-8 rounded-full flex items-center justify-center"></div>
    <p id="notification-text" class="text-sm font-bold text-gray-900"></p>
  </div>
</div>

<script>
  let currentConfig = {};

  async function loadMessages() {
    try {
      const response = await fetch('/api/yaml-config');
      const data = await response.json();
      currentConfig = data;

      document.getElementById('reply_prefix').value = data.bot_settings?.reply_prefix || '';
      document.getElementById('reply_suffix').value = data.bot_settings?.reply_suffix || '';
      document.getElementById('system_prompt').value = data.system_prompt || '';

      const messages = data.messages || {};
      for (const [key, value] of Object.entries(messages)) {
        const input = document.getElementById('msg_' + key);
        if (input) input.value = value;
      }
      showStatus('Settings loaded', 'success');
    } catch (error) {
      showStatus('Load failed: ' + error.message, 'error');
    }
  }

  async function saveMessages(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;

    const updates = {
      'bot_settings.reply_prefix': document.getElementById('reply_prefix').value,
      'bot_settings.reply_suffix': document.getElementById('reply_suffix').value,
      'system_prompt': document.getElementById('system_prompt').value,
    };

    const messageKeys = [
      'empty_input', 'too_short', 'trivial_input', 'gibberish', 'too_long', 'duplicate',
      'rate_limit_chat', 'chat_budget_user', 'chat_budget_guild',
      'pending_approval_chat', 'manual_reply_default', 'rejection_default',
      'ai_error_chat', 'dm_not_allowed', 'invalid_input', 'unknown_error'
    ];

    for (const key of messageKeys) {
      const input = document.getElementById('msg_' + key);
      if (input) updates['messages.' + key] = input.value;
    }

    try {
      const response = await fetch('/api/yaml-config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates })
      });
      if (!response.ok) throw new Error('Save failed');
      showStatus('Global settings saved!', 'success');
    } catch (error) {
      showStatus(error.message, 'error');
    } finally {
      btn.disabled = false;
    }
  }

  function showStatus(message, type) {
    const el = document.getElementById('notification');
    const text = document.getElementById('notification-text');
    const icon = document.getElementById('notification-icon');

    text.textContent = message;
    if (type === 'success') {
      icon.className = 'w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600';
      icon.innerHTML = '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M5 13l4 4L19 7" stroke-width="3" /></svg>';
    } else {
      icon.className = 'w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600';
      icon.innerHTML = '<span>!</span>';
    }

    el.classList.remove('opacity-0', 'translate-y-20');
    setTimeout(() => el.classList.add('opacity-0', 'translate-y-20'), 3000);
  }

  document.getElementById('messages-form').addEventListener('submit', saveMessages);
  document.addEventListener('DOMContentLoaded', loadMessages);
</script>
{% endblock %}